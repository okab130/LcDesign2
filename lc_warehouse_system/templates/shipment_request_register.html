{% extends 'base.html' %}

{% block title %}出庫依頼登録 - LC自動倉庫出庫指示システム{% endblock %}

{% block content %}
<div class="card">
    <h1 class="page-title">出庫依頼登録</h1>
    
    <form id="shipment-request-form">
        <!-- ヘッダー情報 -->
        <div style="background-color: #E3F2FD; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div class="form-group">
                    <label for="base_code">配送拠点 <span style="color: red;">*</span></label>
                    <select id="base_code" name="base_code" required>
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="delivery_date">配送予定日 <span style="color: red;">*</span></label>
                    <input type="date" id="delivery_date" name="delivery_date" required>
                </div>
                <div class="form-group">
                    <label>依頼日</label>
                    <div style="padding: 10px; background: white; border-radius: 5px;">
                        <span id="request_date"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 明細情報 -->
        <div class="section-title" style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #2196F3; border-bottom: 2px solid #2196F3; padding-bottom: 5px;">
            出庫明細
        </div>
        
        <div style="margin-bottom: 20px;">
            <button type="button" class="btn-success" onclick="addDetailRow()">➕ 明細追加</button>
        </div>
        
        <div style="overflow-x: auto;">
            <table id="detail-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">No.</th>
                        <th style="width: 250px;">商品コード <span style="color: red;">*</span></th>
                        <th style="width: 300px;">商品名</th>
                        <th style="width: 150px;">依頼数量 <span style="color: red;">*</span></th>
                        <th style="width: 80px;">操作</th>
                    </tr>
                </thead>
                <tbody id="detail-tbody">
                    <!-- 明細行が動的に追加される -->
                </tbody>
            </table>
        </div>
        
        <div id="error-message" style="display: none;" class="alert alert-error"></div>
        <div id="success-message" style="display: none;" class="alert alert-success"></div>
        
        <!-- ボタン -->
        <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn-secondary" onclick="goBack()">キャンセル</button>
            <button type="submit" class="btn-primary">登録</button>
        </div>
    </form>
</div>

<style>
    .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #2196F3;
        border-bottom: 2px solid #2196F3;
        padding-bottom: 5px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th {
        background-color: #2196F3;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: bold;
    }
    
    td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }
    
    .detail-row {
        background-color: #fafafa;
    }
    
    .detail-row:hover {
        background-color: #f0f0f0;
    }
    
    .line-number {
        text-align: center;
        font-weight: bold;
        color: #666;
    }
    
    .btn-delete-row {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-delete-row:hover {
        background-color: #da190b;
    }
</style>

<script>
let detailRowCount = 0;
let productsCache = [];
let basesCache = [];

// ページ読み込み時の初期化
window.onload = async function() {
    // 今日の日付を設定
    const today = new Date();
    document.getElementById('request_date').textContent = today.toLocaleDateString('ja-JP');
    
    // 明日を配送予定日のデフォルトに
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('delivery_date').value = tomorrow.toISOString().split('T')[0];
    
    // マスタデータ取得
    await loadMasterData();
    
    // 初期明細行を追加
    addDetailRow();
};

async function loadMasterData() {
    try {
        // 配送拠点取得
        const basesResponse = await fetch('/api/v1/delivery-bases/');
        const basesData = await basesResponse.json();
        basesCache = basesData.results || basesData;
        
        const baseSelect = document.getElementById('base_code');
        basesCache.forEach(base => {
            const option = document.createElement('option');
            option.value = base.base_code;
            option.textContent = `${base.base_code} - ${base.base_name}`;
            baseSelect.appendChild(option);
        });
        
        // 商品マスタ取得
        const productsResponse = await fetch('/api/v1/products/');
        const productsData = await productsResponse.json();
        productsCache = productsData.results || productsData;
        
    } catch (error) {
        console.error('マスタデータ取得エラー:', error);
        showError('マスタデータの取得に失敗しました');
    }
}

function addDetailRow() {
    detailRowCount++;
    const tbody = document.getElementById('detail-tbody');
    
    const row = document.createElement('tr');
    row.className = 'detail-row';
    row.id = `row-${detailRowCount}`;
    
    row.innerHTML = `
        <td class="line-number">${detailRowCount}</td>
        <td>
            <select name="product_code_${detailRowCount}" id="product_code_${detailRowCount}" 
                    onchange="updateProductName(${detailRowCount})" style="width: 100%;" required>
                <option value="">選択してください</option>
                ${productsCache.map(p => `<option value="${p.product_code}">${p.product_code}</option>`).join('')}
            </select>
        </td>
        <td>
            <span id="product_name_${detailRowCount}" style="color: #666;"></span>
        </td>
        <td>
            <input type="number" name="quantity_${detailRowCount}" id="quantity_${detailRowCount}" 
                   min="1" step="1" required style="width: 100%;">
        </td>
        <td style="text-align: center;">
            <button type="button" class="btn-delete-row" onclick="deleteRow(${detailRowCount})">削除</button>
        </td>
    `;
    
    tbody.appendChild(row);
}

function updateProductName(rowNum) {
    const productCode = document.getElementById(`product_code_${rowNum}`).value;
    const product = productsCache.find(p => p.product_code === productCode);
    const nameSpan = document.getElementById(`product_name_${rowNum}`);
    
    if (product) {
        nameSpan.textContent = product.product_name;
    } else {
        nameSpan.textContent = '';
    }
}

function deleteRow(rowNum) {
    const row = document.getElementById(`row-${rowNum}`);
    if (row) {
        row.remove();
        // 行番号を振り直す
        renumberRows();
    }
}

function renumberRows() {
    const rows = document.querySelectorAll('#detail-tbody tr');
    rows.forEach((row, index) => {
        const lineNumberCell = row.querySelector('.line-number');
        if (lineNumberCell) {
            lineNumberCell.textContent = index + 1;
        }
    });
}

function goBack() {
    if (confirm('入力内容が破棄されますが、よろしいですか？')) {
        window.location.href = "{% url 'shipment_request_list' %}";
    }
}

function showError(message) {
    const errorEl = document.getElementById('error-message');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    document.getElementById('success-message').style.display = 'none';
    window.scrollTo(0, 0);
}

function showSuccess(message) {
    const successEl = document.getElementById('success-message');
    successEl.textContent = message;
    successEl.style.display = 'block';
    document.getElementById('error-message').style.display = 'none';
    window.scrollTo(0, 0);
}

document.getElementById('shipment-request-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // バリデーション
    const baseCode = document.getElementById('base_code').value;
    const deliveryDate = document.getElementById('delivery_date').value;
    
    if (!baseCode) {
        showError('配送拠点を選択してください');
        return;
    }
    
    if (!deliveryDate) {
        showError('配送予定日を入力してください');
        return;
    }
    
    // 明細データ収集
    const details = [];
    const rows = document.querySelectorAll('#detail-tbody tr');
    
    if (rows.length === 0) {
        showError('明細を1行以上追加してください');
        return;
    }
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const productSelect = row.querySelector('select[name^="product_code_"]');
        const quantityInput = row.querySelector('input[name^="quantity_"]');
        
        if (!productSelect || !quantityInput) continue;
        
        const productCode = productSelect.value;
        const quantity = parseInt(quantityInput.value);
        
        if (!productCode) {
            showError(`${i + 1}行目：商品コードを選択してください`);
            return;
        }
        
        if (!quantity || quantity <= 0) {
            showError(`${i + 1}行目：数量を正しく入力してください`);
            return;
        }
        
        details.push({
            line_number: i + 1,
            product_code: productCode,
            requested_quantity: quantity
        });
    }
    
    // リクエストデータ作成
    const requestData = {
        base_code: baseCode,
        delivery_date: deliveryDate,
        request_status: 'DRAFT',
        details: details
    };
    
    try {
        const response = await fetch('/api/v1/shipment-requests/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showSuccess(`出庫依頼を登録しました（依頼ID: ${result.request_id}）`);
            
            // 3秒後に一覧画面へ遷移
            setTimeout(() => {
                window.location.href = "{% url 'shipment_request_list' %}";
            }, 2000);
        } else {
            const error = await response.json();
            showError('登録に失敗しました: ' + (error.detail || JSON.stringify(error)));
        }
    } catch (error) {
        console.error('登録エラー:', error);
        showError('登録中にエラーが発生しました: ' + error.message);
    }
});
</script>
{% endblock %}
