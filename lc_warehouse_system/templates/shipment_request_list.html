{% extends 'base.html' %}

{% block title %}å‡ºåº«ä¾é ¼ä¸€è¦§ - LCè‡ªå‹•å€‰åº«å‡ºåº«æŒ‡ç¤ºã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="card">
    <h1 class="page-title">å‡ºåº«ä¾é ¼ä¸€è¦§</h1>
    
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <a href="{% url 'shipment_request_register' %}" class="btn-primary">â• æ–°è¦å‡ºåº«ä¾é ¼ç™»éŒ²</a>
        <button type="button" class="btn-success" onclick="sendToLC()" id="send-btn" disabled>ğŸ“¤ LCè‡ªå‹•å€‰åº«ã¸é€ä¿¡</button>
    </div>
    
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <p style="color: #666;">å‡ºåº«ä¾é ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
    </div>
    
    <div id="error-message" style="display: none;" class="alert alert-error"></div>
    <div id="success-message" style="display: none;" class="alert alert-success"></div>
    
    <table id="request-table">
        <thead>
            <tr>
                <th style="width: 50px;"><input type="checkbox" id="check-all" onchange="toggleAllCheckboxes()"></th>
                <th>å‡ºåº«ä¾é ¼ID</th>
                <th>é…é€æ‹ ç‚¹</th>
                <th>é…é€äºˆå®šæ—¥</th>
                <th>ä¾é ¼æ—¥</th>
                <th>åˆè¨ˆæ•°é‡</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="request-tbody">
            <tr>
                <td colspan="8" style="text-align: center; color: #666; padding: 40px;">
                    èª­ã¿è¾¼ã¿ä¸­...
                </td>
            </tr>
        </tbody>
    </table>
    
    <div id="total-count" style="margin-top: 15px; color: #666; font-size: 14px;"></div>
</div>

<style>
    .btn-success {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
    }
    
    .btn-success:hover:not(:disabled) {
        background-color: #45a049;
    }
    
    .btn-success:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    
    .btn-warning {
        background-color: #FF9800;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-warning:hover {
        background-color: #F57C00;
    }
    
    input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
    }
</style>

<script>
let allRequests = [];

async function loadRequests() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-message');
    const tbodyEl = document.getElementById('request-tbody');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        const response = await fetch('/api/v1/shipment-requests/');
        
        if (!response.ok) {
            throw new Error('å‡ºåº«ä¾é ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const data = await response.json();
        allRequests = data.results || data;
        
        if (allRequests.length === 0) {
            tbodyEl.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">å‡ºåº«ä¾é ¼ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        } else {
            displayRequests(allRequests);
        }
        
        document.getElementById('total-count').textContent = `åˆè¨ˆ: ${allRequests.length} ä»¶`;
        
    } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        tbodyEl.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #f44336; padding: 40px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function displayRequests(requests) {
    const tbody = document.getElementById('request-tbody');
    
    const statusMap = {
        'CREATED': 'ä½œæˆæ¸ˆ',
        'SENT': 'é€ä¿¡æ¸ˆ',
        'ERROR': 'ã‚¨ãƒ©ãƒ¼'
    };
    
    const statusColorMap = {
        'CREATED': '#9E9E9E',
        'SENT': '#2196F3',
        'ERROR': '#f44336'
    };
    
    tbody.innerHTML = requests.map(req => `
        <tr>
            <td style="text-align: center;">
                ${req.request_status === 'CREATED' ? `<input type="checkbox" class="request-checkbox" value="${req.request_id}" onchange="updateSendButton()">` : ''}
            </td>
            <td>${req.request_id}</td>
            <td>${req.base_name || req.base_code}</td>
            <td>${req.delivery_date}</td>
            <td>${req.request_date}</td>
            <td style="text-align: right;">${req.total_quantity}</td>
            <td><span style="color: ${statusColorMap[req.request_status]}; font-weight: bold;">${statusMap[req.request_status]}</span></td>
            <td>
                <button class="btn-primary" style="font-size: 12px; padding: 5px 10px;" onclick="viewDetail('${req.request_id}')">ğŸ“‹ è©³ç´°</button>
                ${req.request_status === 'CREATED' ? `<button class="btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deleteRequest('${req.request_id}')">ğŸ—‘ï¸ å‰Šé™¤</button>` : ''}
                ${req.request_status === 'ERROR' ? `<button class="btn-warning" style="font-size: 12px; padding: 5px 10px;" onclick="resendRequest('${req.request_id}')">ğŸ”„ å†é€</button>` : ''}
            </td>
        </tr>
    `).join('');
    
    updateSendButton();
}

function toggleAllCheckboxes() {
    const checkAll = document.getElementById('check-all');
    const checkboxes = document.querySelectorAll('.request-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = checkAll.checked;
    });
    
    updateSendButton();
}

function updateSendButton() {
    const checkboxes = document.querySelectorAll('.request-checkbox:checked');
    const sendBtn = document.getElementById('send-btn');
    
    sendBtn.disabled = checkboxes.length === 0;
}

function viewDetail(requestId) {
    window.location.href = `/shipment-request/${requestId}/`;
}

async function deleteRequest(requestId) {
    if (!confirm('ã“ã®å‡ºåº«ä¾é ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/shipment-requests/${requestId}/`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        showSuccess('å‰Šé™¤ã—ã¾ã—ãŸ');
        loadRequests();
    } catch (error) {
        showError(error.message);
    }
}

async function sendToLC() {
    const checkboxes = document.querySelectorAll('.request-checkbox:checked');
    
    if (checkboxes.length === 0) {
        showError('é€ä¿¡ã™ã‚‹å‡ºåº«ä¾é ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const requestIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (!confirm(`${requestIds.length}ä»¶ã®å‡ºåº«ä¾é ¼ã‚’LCè‡ªå‹•å€‰åº«ã¸é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/shipment-requests/send_to_lc/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_ids: requestIds
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'LCè‡ªå‹•å€‰åº«ã¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const result = await response.json();
        showSuccess(result.message);
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('check-all').checked = false;
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
        setTimeout(() => {
            loadRequests();
        }, 2000);
        
    } catch (error) {
        showError(error.message);
    }
}

async function resendRequest(requestId) {
    if (!confirm('ã“ã®å‡ºåº«ä¾é ¼ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    await sendToLC();
}

function showError(message) {
    const errorEl = document.getElementById('error-message');
    const successEl = document.getElementById('success-message');
    
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    successEl.style.display = 'none';
    
    window.scrollTo(0, 0);
}

function showSuccess(message) {
    const errorEl = document.getElementById('error-message');
    const successEl = document.getElementById('success-message');
    
    successEl.textContent = message;
    successEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    window.scrollTo(0, 0);
}

window.onload = loadRequests;
</script>
{% endblock %}
