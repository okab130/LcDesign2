{% extends 'base.html' %}

{% block title %}åœ¨åº«ç…§ä¼š - LCè‡ªå‹•å€‰åº«å‡ºåº«æŒ‡ç¤ºã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="card">
    <h1 class="page-title">åœ¨åº«ç…§ä¼š</h1>
    
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <button class="btn-success" onclick="refreshInventory()">ğŸ”„ æœ€æ–°åŒ–</button>
            <span id="last-updated" style="margin-left: 15px; color: #666; font-size: 14px;"></span>
        </div>
        <div>
            <input type="text" id="search" placeholder="å•†å“ã‚³ãƒ¼ãƒ‰ã€ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€å·¥å ´ã§æ¤œç´¢..." 
                   style="width: 300px; padding: 8px;" onkeyup="filterTable()">
        </div>
    </div>
    
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <p style="color: #666;">åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
    </div>
    
    <div id="error-message" style="display: none;" class="alert alert-error"></div>
    
    <div id="inventory-table-container">
        <table id="inventory-table">
            <thead>
                <tr>
                    <th>ãƒ‘ãƒ¬ãƒƒãƒˆID</th>
                    <th>å•†å“ã‚³ãƒ¼ãƒ‰</th>
                    <th>ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</th>
                    <th>å·¥å ´ã‚³ãƒ¼ãƒ‰</th>
                    <th>ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰</th>
                    <th>è£½é€ ç•ªå·</th>
                    <th>è£½é€ æ—¥</th>
                    <th>æ¶ˆè²»æœŸé™</th>
                    <th>æ•°é‡</th>
                    <th>å…¥åº«åŒºåˆ†</th>
                    <th>å…¥åº«æ—¥æ™‚</th>
                </tr>
            </thead>
            <tbody id="inventory-tbody">
                <tr>
                    <td colspan="11" style="text-align: center; color: #666; padding: 40px;">
                        ã€Œæœ€æ–°åŒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div id="total-count" style="margin-top: 15px; color: #666; font-size: 14px;"></div>
</div>

<script>
let inventoryData = [];

async function refreshInventory() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-message');
    const tbodyEl = document.getElementById('inventory-tbody');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    
    try {
        const response = await fetch('http://localhost:5001/api/v1/inventory');
        
        if (!response.ok) {
            throw new Error('åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const data = await response.json();
        inventoryData = data.inventories || [];
        
        displayInventory(inventoryData);
        
        const now = new Date();
        document.getElementById('last-updated').textContent = 
            `æœ€çµ‚æ›´æ–°: ${now.toLocaleString('ja-JP')}`;
        
        document.getElementById('total-count').textContent = 
            `åˆè¨ˆ: ${inventoryData.length} ä»¶`;
        
    } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        tbodyEl.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #f44336; padding: 40px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>';
    } finally {
        loadingEl.style.display = 'none';
    }
}

function displayInventory(data) {
    const tbody = document.getElementById('inventory-tbody');
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666; padding: 40px;">åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(item => `
        <tr>
            <td>${item.pallet_id}</td>
            <td>${item.product_code}</td>
            <td>${item.location_code}</td>
            <td>${item.factory_code}</td>
            <td>${item.line_code}</td>
            <td>${item.production_number}</td>
            <td>${item.production_date}</td>
            <td>${item.expiry_date}</td>
            <td style="text-align: right;">${item.quantity.toLocaleString()}</td>
            <td>${item.entry_type === 'AUTO' ? 'è‡ªå‹•å…¥åº«' : 'æ‰‹å‹•å…¥åº«'}</td>
            <td>${new Date(item.entry_datetime).toLocaleString('ja-JP')}</td>
        </tr>
    `).join('');
}

function filterTable() {
    const searchValue = document.getElementById('search').value.toLowerCase();
    
    if (searchValue === '') {
        displayInventory(inventoryData);
        document.getElementById('total-count').textContent = 
            `åˆè¨ˆ: ${inventoryData.length} ä»¶`;
        return;
    }
    
    const filtered = inventoryData.filter(item => 
        item.product_code.toLowerCase().includes(searchValue) ||
        item.location_code.toLowerCase().includes(searchValue) ||
        item.factory_code.toLowerCase().includes(searchValue)
    );
    
    displayInventory(filtered);
    document.getElementById('total-count').textContent = 
        `è¡¨ç¤º: ${filtered.length} ä»¶ / åˆè¨ˆ: ${inventoryData.length} ä»¶`;
}
</script>
{% endblock %}
