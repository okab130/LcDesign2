{% extends 'base.html' %}

{% block title %}å‡ºåº«ä¾é ¼è©³ç´° - LCè‡ªå‹•å€‰åº«å‡ºåº«æŒ‡ç¤ºã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="card">
    <h1 class="page-title">å‡ºåº«ä¾é ¼è©³ç´°</h1>
    
    <div id="loading" style="display: block; text-align: center; padding: 40px;">
        <p style="color: #666;">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
    </div>
    
    <div id="error-message" style="display: none;" class="alert alert-error"></div>
    
    <div id="detail-content" style="display: none;">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± -->
        <div style="background-color: #E3F2FD; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div class="info-group">
                    <label>å‡ºåº«ä¾é ¼ID</label>
                    <div class="value" id="request_id"></div>
                </div>
                <div class="info-group">
                    <label>é…é€æ‹ ç‚¹</label>
                    <div class="value" id="base_name"></div>
                </div>
                <div class="info-group">
                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <div class="value" id="request_status"></div>
                </div>
                <div class="info-group">
                    <label>ä¾é ¼æ—¥</label>
                    <div class="value" id="request_date"></div>
                </div>
                <div class="info-group">
                    <label>é…é€äºˆå®šæ—¥</label>
                    <div class="value" id="delivery_date"></div>
                </div>
                <div class="info-group">
                    <label>åˆè¨ˆæ•°é‡</label>
                    <div class="value" id="total_quantity"></div>
                </div>
                <div class="info-group">
                    <label>ä¾é ¼è€…</label>
                    <div class="value" id="requested_by"></div>
                </div>
                <div class="info-group">
                    <label>ä¾é ¼æ—¥æ™‚</label>
                    <div class="value" id="requested_at"></div>
                </div>
                <div class="info-group" id="sent-info" style="display: none;">
                    <label>é€ä¿¡æ—¥æ™‚</label>
                    <div class="value" id="sent_at"></div>
                </div>
            </div>
        </div>
        
        <!-- æ˜ç´°æƒ…å ± -->
        <div class="section-title">å‡ºåº«æ˜ç´°</div>
        
        <table>
            <thead>
                <tr>
                    <th style="width: 60px;">è¡Œç•ªå·</th>
                    <th style="width: 150px;">å•†å“ã‚³ãƒ¼ãƒ‰</th>
                    <th>å•†å“å</th>
                    <th style="width: 120px; text-align: right;">ä¾é ¼æ•°é‡</th>
                </tr>
            </thead>
            <tbody id="details-tbody">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</td>
                </tr>
            </tbody>
        </table>
        
        <!-- ãƒœã‚¿ãƒ³ -->
        <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn-secondary" onclick="goBack()">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
            <button type="button" class="btn-success" id="send-btn" style="display: none;" onclick="sendToLC()">ğŸ“¤ LCè‡ªå‹•å€‰åº«ã¸é€ä¿¡</button>
            <button type="button" class="btn-danger" id="delete-btn" style="display: none;" onclick="deleteRequest()">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
    </div>
</div>

<style>
    .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #2196F3;
        border-bottom: 2px solid #2196F3;
        padding-bottom: 5px;
    }
    
    .info-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .info-group label {
        font-size: 12px;
        color: #666;
    }
    
    .info-group .value {
        font-size: 16px;
        font-weight: bold;
        color: #333;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th {
        background-color: #2196F3;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: bold;
    }
    
    td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }
    
    .btn-success {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .btn-success:hover {
        background-color: #45a049;
    }
</style>

<script>
let currentRequestId = '';
let currentRequest = null;

window.onload = function() {
    // URLã‹ã‚‰ä¾é ¼IDã‚’å–å¾—
    const pathParts = window.location.pathname.split('/');
    currentRequestId = pathParts[pathParts.length - 2];
    
    loadRequestDetail();
};

async function loadRequestDetail() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-message');
    const contentEl = document.getElementById('detail-content');
    
    try {
        const response = await fetch(`/api/v1/shipment-requests/${currentRequestId}/`);
        
        if (!response.ok) {
            throw new Error('å‡ºåº«ä¾é ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        currentRequest = await response.json();
        
        displayRequestDetail(currentRequest);
        
        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
        
    } catch (error) {
        loadingEl.style.display = 'none';
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
    }
}

function displayRequestDetail(request) {
    const statusMap = {
        'CREATED': 'ä½œæˆæ¸ˆ',
        'SENT': 'é€ä¿¡æ¸ˆ',
        'ERROR': 'ã‚¨ãƒ©ãƒ¼'
    };
    
    const statusColorMap = {
        'CREATED': '#9E9E9E',
        'SENT': '#2196F3',
        'ERROR': '#f44336'
    };
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
    document.getElementById('request_id').textContent = request.request_id;
    document.getElementById('base_name').textContent = request.base_name || request.base_code;
    
    const statusEl = document.getElementById('request_status');
    statusEl.textContent = statusMap[request.request_status];
    statusEl.style.color = statusColorMap[request.request_status];
    
    document.getElementById('request_date').textContent = request.request_date;
    document.getElementById('delivery_date').textContent = request.delivery_date;
    document.getElementById('total_quantity').textContent = request.total_quantity + ' ã‚±ãƒ¼ã‚¹';
    document.getElementById('requested_by').textContent = request.requested_by_name || 'æœªè¨­å®š';
    document.getElementById('requested_at').textContent = request.requested_at ? new Date(request.requested_at).toLocaleString('ja-JP') : '-';
    
    if (request.sent_at) {
        document.getElementById('sent-info').style.display = 'block';
        document.getElementById('sent_at').textContent = new Date(request.sent_at).toLocaleString('ja-JP');
    }
    
    // æ˜ç´°æƒ…å ±
    const detailsTbody = document.getElementById('details-tbody');
    
    if (request.details && request.details.length > 0) {
        detailsTbody.innerHTML = request.details.map(detail => `
            <tr>
                <td style="text-align: center;">${detail.line_number}</td>
                <td>${detail.product_code}</td>
                <td>${detail.product_name || ''}</td>
                <td style="text-align: right;">${detail.requested_quantity}</td>
            </tr>
        `).join('');
    } else {
        detailsTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    }
    
    // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
    if (request.request_status === 'CREATED') {
        document.getElementById('send-btn').style.display = 'inline-block';
        document.getElementById('delete-btn').style.display = 'inline-block';
    }
}

function goBack() {
    window.location.href = "{% url 'shipment_request_list' %}";
}

async function sendToLC() {
    if (!confirm('ã“ã®å‡ºåº«ä¾é ¼ã‚’LCè‡ªå‹•å€‰åº«ã¸é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/shipment-requests/send_to_lc/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_ids: [currentRequestId]
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'LCè‡ªå‹•å€‰åº«ã¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const result = await response.json();
        alert(result.message);
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
        loadRequestDetail();
        
    } catch (error) {
        alert(error.message);
    }
}

async function deleteRequest() {
    if (!confirm('ã“ã®å‡ºåº«ä¾é ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/shipment-requests/${currentRequestId}/`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
        goBack();
        
    } catch (error) {
        alert(error.message);
    }
}
</script>
{% endblock %}
