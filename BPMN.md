# BPMN（Business Process Model and Notation）

## 1. 出庫依頼作成・送信プロセス

### 1.1 全体フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Pool: LC出庫指示システム業務プロセス                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ Lane: 拠点倉庫担当                                                      │
│                                                                         │
│  ○────►┌─────────┐─────►┌─────────┐─────►┌─────────┐─────►●          │
│ Start  │出庫依頼 │      │商品・数量│      │依頼登録 │      End         │
│        │作成開始 │      │入力     │      │確定     │                  │
│        └─────────┘      └─────────┘      └─────────┘                  │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ Lane: LC倉庫担当                                                        │
│                                                                         │
│                           ○────►┌─────────┐                            │
│                          Start  │依頼一覧 │                            │
│                                 │確認     │                            │
│                                 └────┬────┘                            │
│                                      │                                 │
│                                      ▼                                 │
│                                 ┌─────────┐                            │
│                                 │在庫確認 │                            │
│                                 └────┬────┘                            │
│                                      │                                 │
│                                      ▼                                 │
│                                 ◇─────────◇                            │
│                                 │在庫十分?│                            │
│                                 └─┬─────┬─┘                            │
│                                   │No   │Yes                          │
│                       ┌───────────┘     └───────────┐                 │
│                       ▼                             ▼                 │
│                  ┌─────────┐                   ┌─────────┐            │
│                  │数量調整 │                   │拠点選択 │            │
│                  │・修正   │                   │(複数可) │            │
│                  └────┬────┘                   └────┬────┘            │
│                       │                             │                 │
│                       └──────────┬──────────────────┘                 │
│                                  ▼                                     │
│                             ┌─────────┐                                │
│                             │送信実行 │                                │
│                             └────┬────┘                                │
│                                  │                                     │
│                                  ▼                                     │
│                             ◇─────────◇                                │
│                             │送信成功?│                                │
│                             └─┬─────┬─┘                                │
│                               │Yes  │No                               │
│                   ┌───────────┘     └───────────┐                     │
│                   ▼                             ▼                     │
│              ┌─────────┐                   ┌─────────┐                │
│              │ステータス│                   │エラー表示│                │
│              │: 送信済 │                   │・再送準備│                │
│              └────┬────┘                   └─────────┘                │
│                   │                                                   │
│                   ▼                                                   │
│                   ●                                                   │
│                  End                                                  │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ Lane: LC自動倉庫システム                                                │
│                                                                         │
│                                  ○────►┌─────────┐                     │
│                                 Start  │依頼受信 │                     │
│                                        └────┬────┘                     │
│                                             │                          │
│                                             ▼                          │
│                                        ┌─────────┐                     │
│                                        │在庫引当 │                     │
│                                        └────┬────┘                     │
│                                             │                          │
│                                             ▼                          │
│                                        ┌─────────┐                     │
│                                        │出庫処理 │                     │
│                                        └────┬────┘                     │
│                                             │                          │
│                                             ▼                          │
│                                        ┌─────────┐                     │
│                                        │実績送信 │                     │
│                                        │(Webhook)│                     │
│                                        └────┬────┘                     │
│                                             │                          │
│                                             ▼                          │
│                                             ●                          │
│                                            End                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 出庫依頼登録の詳細フロー（拠点倉庫担当）

```
     ○ Start
     │
     ▼
┌─────────┐
│画面起動 │
└────┬────┘
     │
     ▼
┌──────────────┐
│配送予定日    │
│自動設定      │
│(翌営業日)    │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│商品選択      │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│数量入力      │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│パレット倍数? │
└─┬──────────┬─┘
  │No        │Yes
  │          │
  ▼          │
┌──────────┐ │
│エラー表示│ │
└────┬─────┘ │
     │        │
     └────────┘
     │
     ▼
◇──────────────◇
│追加商品あり? │
└─┬──────────┬─┘
  │Yes       │No
  │          │
  │          ▼
  │     ┌──────────┐
  │     │一時保存? │
  │     └─┬────┬───┘
  │       │Yes │No
  │       ▼    │
  │  ┌─────────┐│
  │  │下書保存 ││
  │  └────┬────┘│
  │       │     │
  │       └─────┘
  │             │
  └─────────────┘
                │
                ▼
           ┌─────────┐
           │依頼確定 │
           │登録     │
           └────┬────┘
                │
                ▼
           ┌─────────┐
           │ステータス│
           │: 作成済 │
           └────┬────┘
                │
                ▼
                ● End
```

### 1.3 出庫依頼送信の詳細フロー（LC倉庫担当）

```
     ○ Start
     │
     ▼
┌──────────────┐
│依頼一覧画面  │
│表示          │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│検索条件設定  │
│・配送予定日  │
│・拠点        │
│・ステータス  │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│依頼一覧取得  │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│在庫照会画面  │
│で在庫確認    │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│在庫不足あり? │
└─┬──────────┬─┘
  │Yes       │No
  │          │
  ▼          │
┌──────────┐ │
│拠点担当へ│ │
│連絡      │ │
└────┬─────┘ │
     │        │
     ▼        │
┌──────────┐ │
│依頼修正  │ │
│(数量調整)│ │
└────┬─────┘ │
     │        │
     └────────┘
     │
     ▼
┌──────────────┐
│送信対象を    │
│チェックボックス│
│で選択(複数可)│
└────┬─────────┘
     │
     ▼
┌──────────────┐
│送信ボタン押下│
└────┬─────────┘
     │
     ▼
┌──────────────┐
│REST API送信  │
│POST /api/v1/ │
│shipment-     │
│requests      │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│全拠点成功?   │
└─┬──────────┬─┘
  │No        │Yes
  │          │
  ▼          ▼
┌──────────┐┌──────────┐
│一部エラー││全拠点    │
│表示      ││送信済    │
└────┬─────┘└────┬─────┘
     │           │
     ▼           ▼
┌──────────┐┌──────────┐
│成功拠点: ││ステータス│
│送信済    ││更新完了  │
│失敗拠点: │└────┬─────┘
│エラー    │     │
└────┬─────┘     │
     │           │
     └───────────┘
                 │
                 ▼
                 ● End
```

---

## 2. 出庫実績受信プロセス

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Pool: 出庫実績受信プロセス                                              │
├─────────────────────────────────────────────────────────────────────────┤
│ Lane: LC自動倉庫システム                                                │
│                                                                         │
│  ○────►┌─────────┐─────►┌─────────┐─────►┌─────────┐                 │
│ Start  │出庫完了 │      │実績データ│      │Webhook  │                 │
│        │         │      │作成     │      │送信     │                 │
│        └─────────┘      └─────────┘      └────┬────┘                 │
│                                                │                       │
│                                                │POST                   │
│                                                │/api/v1/               │
│                                                │shipment-results       │
│                                                │                       │
├────────────────────────────────────────────────┼─────────────────────────┤
│ Lane: LC出庫指示システム                       │                       │
│                                                ▼                       │
│                                           ┌─────────┐                  │
│                                           │リクエスト│                  │
│                                           │受信     │                  │
│                                           └────┬────┘                  │
│                                                │                       │
│                                                ▼                       │
│                                           ┌─────────┐                  │
│                                           │JSON解析 │                  │
│                                           └────┬────┘                  │
│                                                │                       │
│                                                ▼                       │
│                                           ◇─────────◇                  │
│                                           │解析成功?│                  │
│                                           └─┬─────┬─┘                  │
│                                             │No   │Yes                │
│                                 ┌───────────┘     └───────────┐       │
│                                 ▼                             ▼       │
│                            ┌─────────┐                   ┌─────────┐  │
│                            │HTTP 400 │                   │データ   │  │
│                            │返却     │                   │検証     │  │
│                            └────┬────┘                   └────┬────┘  │
│                                 │                             │       │
│                                 ▼                             ▼       │
│                            ┌─────────┐                   ◇─────────◇  │
│                            │ログ出力 │                   │検証OK?  │  │
│                            └────┬────┘                   └─┬─────┬─┘  │
│                                 │                          │No   │Yes│
│                                 ▼                          │     │   │
│                                 ●              ┌───────────┘     │   │
│                                End             ▼                 ▼   │
│                                           ┌─────────┐       ┌─────────┐│
│                                           │HTTP 400 │       │DB保存  ││
│                                           │返却     │       │        ││
│                                           └────┬────┘       └────┬────┘│
│                                                │                 │   │
│                                                ▼                 ▼   │
│                                           ┌─────────┐       ◇─────────◇│
│                                           │ログ出力 │       │保存成功?││
│                                           └────┬────┘       └─┬─────┬─┘│
│                                                │              │No   │Yes│
│                                                ▼              │     │ │
│                                                ●  ┌───────────┘     │ │
│                                               End │                 │ │
│                                                   ▼                 ▼ │
│                                              ┌─────────┐       ┌─────────┐│
│                                              │HTTP 500 │       │HTTP 200││
│                                              │返却     │       │OK返却  ││
│                                              └────┬────┘       └────┬────┘│
│                                                   │                 │ │
│                                                   ▼                 ▼ │
│                                              ┌─────────┐            ● │
│                                              │ログ出力 │           End│
│                                              └────┬────┘              │
│                                                   │                   │
│                                                   ▼                   │
│                                                   ●                   │
│                                                  End                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 在庫照会プロセス

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Pool: 在庫照会プロセス                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ Lane: ユーザー（全権限）                                                │
│                                                                         │
│  ○────►┌─────────┐─────►┌─────────┐─────►┌─────────┐                 │
│ Start  │在庫照会 │      │最新化   │      │在庫一覧 │                 │
│        │画面表示 │      │ボタン押下│      │確認     │                 │
│        └─────────┘      └────┬────┘      └─────────┘                 │
│                              │                    │                    │
│                              │API呼び出し         │                    │
│                              │                    ▼                    │
│                              │                    ●                    │
│                              │                   End                   │
├──────────────────────────────┼────────────────────────────────────────┤
│ Lane: LC出庫指示システム     │                                        │
│                              ▼                                        │
│                         ┌─────────┐                                   │
│                         │GET      │                                   │
│                         │/api/v1/ │                                   │
│                         │inventory│                                   │
│                         └────┬────┘                                   │
│                              │                                        │
├──────────────────────────────┼────────────────────────────────────────┤
│ Lane: LC自動倉庫システム     │                                        │
│                              ▼                                        │
│                         ┌─────────┐                                   │
│                         │在庫情報 │                                   │
│                         │取得     │                                   │
│                         └────┬────┘                                   │
│                              │                                        │
│                              ▼                                        │
│                         ┌─────────┐                                   │
│                         │JSON返却 │                                   │
│                         └────┬────┘                                   │
│                              │                                        │
├──────────────────────────────┼────────────────────────────────────────┤
│ Lane: LC出庫指示システム     │                                        │
│                              ▼                                        │
│                         ┌─────────┐                                   │
│                         │データ変換│                                   │
│                         └────┬────┘                                   │
│                              │                                        │
│                              ▼                                        │
│                         ◇─────────◇                                   │
│                         │取得成功?│                                   │
│                         └─┬─────┬─┘                                   │
│                           │No   │Yes                                 │
│               ┌───────────┘     └───────────┐                         │
│               ▼                             ▼                         │
│          ┌─────────┐                   ┌─────────┐                    │
│          │エラー   │                   │画面に   │                    │
│          │ポップ  │                   │在庫表示 │                    │
│          │アップ  │                   │(DB保存  │                    │
│          │表示    │                   │なし)    │                    │
│          └────┬────┘                   └────┬────┘                    │
│               │                             │                         │
│               ▼                             ▼                         │
│               ●                             ●                         │
│              End                           End                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. マスタ管理プロセス

### 4.1 商品マスタ管理（LC倉庫担当）

```
     ○ Start
     │
     ▼
┌──────────────┐
│商品マスタ    │
│管理画面表示  │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│操作種別選択  │
└─┬─────┬────┬─┘
  │登録  │更新│削除
  │     │    │
  ▼     ▼    ▼
┌────┐┌────┐┌────┐
│新規││編集││論理│
│登録││    ││削除│
└─┬──┘└─┬──┘└─┬──┘
  │     │     │
  └──┬──┴──┬──┘
     │     │
     ▼     ▼
┌──────────────┐
│商品コード    │
│商品名        │
│パレット積載  │
│ケース数入力  │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│入力検証      │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│検証OK?       │
└─┬──────────┬─┘
  │No        │Yes
  │          │
  ▼          ▼
┌──────────┐┌──────────┐
│エラー表示││DB保存    │
└────┬─────┘└────┬─────┘
     │           │
     └───────────┘
                 │
                 ▼
           ┌──────────┐
           │完了メッセージ│
           │表示      │
           └────┬─────┘
                │
                ▼
                ● End
```

### 4.2 配送拠点マスタ取り込み（管理者/LC倉庫担当）

```
     ○ Start
     │
     ▼
┌──────────────┐
│取り込み画面  │
│表示          │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│共有フォルダ  │
│からCSVファイル│
│選択          │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│取り込みボタン│
│押下          │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│CSVファイル   │
│読み込み      │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│読み込み成功? │
└─┬──────────┬─┘
  │No        │Yes
  │          │
  ▼          ▼
┌──────────┐┌──────────┐
│エラー表示││既存データ│
└────┬─────┘│削除      │
     │      └────┬─────┘
     │           │
     │           ▼
     │      ┌──────────┐
     │      │新データ  │
     │      │一括登録  │
     │      └────┬─────┘
     │           │
     │           ▼
     │      ◇──────────◇
     │      │登録成功? │
     │      └─┬────┬───┘
     │        │No  │Yes
     │        │    │
     │        ▼    ▼
     │   ┌────────┐┌────────┐
     │   │ロール  ││完了    │
     │   │バック  ││メッセージ│
     │   └────┬───┘│表示    │
     │        │    └────┬───┘
     │        ▼         │
     │   ┌────────┐    │
     │   │エラー表示│    │
     │   └────┬───┘    │
     │        │         │
     └────────┴─────────┘
                        │
                        ▼
                        ● End
```

---

## 5. ユーザー管理プロセス（管理者）

```
     ○ Start
     │
     ▼
┌──────────────┐
│ユーザー管理  │
│画面表示      │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│操作種別選択  │
└─┬─────┬────┬─┘
  │登録  │更新│無効化
  │     │    │
  ▼     ▼    ▼
┌────┐┌────┐┌────┐
│新規││編集││無効│
│登録││    ││フラグ│
└─┬──┘└─┬──┘└─┬──┘
  │     │     │
  └──┬──┴──┬──┘
     │     │
     ▼     ▼
┌──────────────┐
│ユーザー情報  │
│入力          │
│・ユーザーID  │
│・氏名        │
│・ユーザー区分│
│・所属拠点    │
│・初期PW      │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│入力検証      │
│・重複チェック│
│・形式チェック│
└────┬─────────┘
     │
     ▼
◇──────────────◇
│検証OK?       │
└─┬──────────┬─┘
  │No        │Yes
  │          │
  ▼          ▼
┌──────────┐┌──────────┐
│エラー表示││パスワード│
└────┬─────┘│ハッシュ化│
     │      └────┬─────┘
     │           │
     │           ▼
     │      ┌──────────┐
     │      │DB保存    │
     │      └────┬─────┘
     │           │
     │           ▼
     │      ◇──────────◇
     │      │保存成功? │
     │      └─┬────┬───┘
     │        │No  │Yes
     │        │    │
     │        ▼    ▼
     │   ┌────────┐┌────────┐
     │   │エラー  ││初期PW  │
     │   │表示    ││メール  │
     │   └────┬───┘│送信    │
     │        │    └────┬───┘
     │        │         │
     └────────┴─────────┘
                        │
                        ▼
                  ┌──────────┐
                  │完了      │
                  │メッセージ│
                  │表示      │
                  └────┬─────┘
                       │
                       ▼
                       ● End
```

---

## 6. エラーハンドリングプロセス

### 6.1 API通信エラー

```
     ○ APIエラー発生
     │
     ▼
◇──────────────◇
│エラー種別判定│
└─┬─────┬────┬─┘
  │タイム│接続│HTTP
  │アウト│エラー│エラー
  │     │    │
  ▼     ▼    ▼
┌────┐┌────┐┌────┐
│30秒││ネット││400/│
│超過││ワーク││500 │
└─┬──┘└─┬──┘└─┬──┘
  │     │     │
  └──┬──┴──┬──┘
     │     │
     ▼     ▼
┌──────────────┐
│ログ出力      │
│・エラー詳細  │
│・タイムスタンプ│
│・ユーザーID  │
│・API URL     │
└────┬─────────┘
     │
     ▼
◇──────────────◇
│画面操作中?   │
└─┬──────────┬─┘
  │Yes       │No
  │          │
  ▼          │
┌──────────┐ │
│ポップアップ││
│エラー表示│ │
└────┬─────┘ │
     │        │
     └────────┘
                │
                ▼
                ● End
```

### 6.2 データ検証エラー

```
     ○ 検証エラー発生
     │
     ▼
◇──────────────◇
│エラー種別判定│
└─┬─────┬────┬─┘
  │必須 │形式 │業務
  │エラー│エラー│ルール
  │     │    │
  ▼     ▼    ▼
┌────┐┌────┐┌────┐
│未入力││数値││パレット│
│     ││形式││倍数   │
└─┬──┘└─┬──┘└─┬──┘
  │     │     │
  └──┬──┴──┬──┘
     │     │
     ▼     ▼
┌──────────────┐
│エラーメッセージ│
│生成          │
└────┬─────────┘
     │
     ▼
┌──────────────┐
│画面にエラー  │
│表示          │
│(項目ハイライト)│
└────┬─────────┘
     │
     ▼
┌──────────────┐
│入力欄に      │
│フォーカス    │
└────┬─────────┘
     │
     ▼
     ● End
```

---

## 7. イベント定義

### 開始イベント
- **ユーザー操作**: 画面操作による業務開始
- **スケジュール**: 定期処理開始（現状なし）
- **メッセージ受信**: Webhook受信

### 終了イベント
- **正常終了**: 業務処理完了
- **エラー終了**: エラー発生による中断
- **キャンセル**: ユーザーによる操作中断

### 中間イベント
- **タイマーイベント**: タイムアウト検知
- **エラーイベント**: 例外発生
- **メッセージ送信**: API送信

---

## 8. ゲートウェイ定義

### 排他ゲートウェイ（XOR）
- **条件分岐**: 在庫十分？、送信成功？、検証OK？
- **操作種別**: 登録/更新/削除

### 並行ゲートウェイ（AND）
- 現状では使用なし（将来的な拡張に備えて定義）

---

## 9. アクティビティ定義

### タスク
- **ユーザータスク**: 画面操作が必要な処理
- **サービスタスク**: システムが自動実行する処理
- **送信タスク**: 外部システムへのAPI送信
- **受信タスク**: 外部システムからのデータ受信

### サブプロセス
- **在庫確認サブプロセス**: API呼び出し～データ取得～表示
- **データ検証サブプロセス**: 必須チェック～形式チェック～業務ルールチェック
