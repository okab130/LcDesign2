# 飲料製造、販売、配送業の企業のLC自動化倉庫の出庫指示機能の設計

LCとは、ロジスティクスセンターを意味する。

---

## 1. お客様・事業の概要

### お客様の基本情報
- **事業名**: アルファ飲料・情報システム部
- **業種**: 製造、卸
- **事業規模**: 従業員数：1000名、拠点数：30、年間売上：2500億円
- **主要な事業内容**: 具体的な商品：アルコーラ、アルコーヒー、アルオレンジ、アルミルクなど

### 業務全体の流れ
製造 → LC自動倉庫保管・出庫・配送拠点へ配送 → 受注 → 配送拠点から顧客へ配送 → 売上計上 → 請求

**補足**:
- 出庫依頼は配送拠点への在庫補充が主目的（見込み補充）
- 受注は配送拠点で実施
- 受注情報と出庫依頼は関連するが、システム上は出庫依頼作成に受注情報は不要

### 今回のシステム化対象範囲
- **対象業務**: LC自動倉庫保管・出庫・配送拠点へ配送
- **対象部門**: 倉庫管理部
- **システム化する理由・課題**: LC自動倉庫の刷新に伴う、LC自動倉庫への出庫指示機能を再構築する
- **LC自動倉庫システム**: 仕様が決まっており、検討対象外とする
- **想定するシステム機能**:
  1. LC自動倉庫在庫受信・在庫更新
  2. LC出庫依頼登録・送信
  3. LC出庫実績格納
  4. LC出庫実績検索
  5. 在庫照会
  6. 商品マスタ管理
  7. ユーザー管理

---

## 2. LC自動倉庫の機能概要

### 倉庫内商品の管理
- パレット単位で格納
- 入庫時にパレットIDを付与
- 管理項目：商品コード、倉庫内ロケーション、製造工場、ライン、製造番号、製造年月日、賞味期限

### 入庫
- パレット単位の入庫
- 工場とLC自動倉庫直結ラインで自動入庫
- 手動入庫も可能

### 出庫
- パレット単位の出庫
- 出庫指示システムから出庫依頼インタフェース（CSV）を受信し、自動出庫
- 自動出庫完了後、出庫実績をインタフェース（CSV）で送信
- 手動出庫も可能（緊急出庫、廃棄など）
- **在庫引当はLC自動倉庫側で実施**（本システムでは管理しない）

---

## 3. LC自動倉庫のシステムインタフェース

### 3.1 在庫情報インタフェース（取得）
- **データの流れ**: 出庫指示システム → LC自動倉庫（REST API呼び出し）
- **取得タイミング**: 在庫照会画面で「最新化」ボタン押下時
- **通信方式**: REST API（Pull型）、HTTPS
- **APIエンドポイント**: GET https://lc-warehouse-api.example.com/api/v1/inventory
- **認証方式**: JWTトークン（Authorizationヘッダー: Bearer {token}）
- **データ形式**: JSON
- **データ種別**: 全量データ
- **処理方式**: 画面表示のみ（データベース保存なし）
- **手動入庫**: 在庫情報に含まれる（自動入庫との違いなし）
- **エラーハンドリング**: タイムアウト・APIエラー発生時は画面にポップアップでエラー表示（リトライなし）

### 3.2 配送拠点マスタインタフェース（受信）
- **データの流れ**: 別システム → 出庫指示システム
- **送信タイミング**: 不定期（必要時のみ手動取り込み）
- **データ形式**: CSV（UTF-8、ヘッダ付き）
- **データ種別**: 全量データ
- **配置場所**: 共有フォルダ
- **ファイル名**: delivery_base_YYYYMMDD.csv
- **処理方式**: 前日データを削除して全量入れ替え
- **データ内容**: 拠点コード、拠点名
- **取り込み方法**: 管理者またはLC倉庫担当が画面から手動で取り込み指示

### 3.3 出庫依頼インタフェース（送信）
- **データの流れ**: 出庫指示システム → LC自動倉庫（REST API呼び出し）
- **送信タイミング**: 画面操作で随時送信（LC倉庫担当が操作）
- **通信方式**: REST API、HTTPS
- **APIエンドポイント**: POST https://lc-warehouse-api.example.com/api/v1/shipment-requests
- **認証方式**: JWTトークン（Authorizationヘッダー: Bearer {token}）
- **データ形式**: JSON
- **送信単位**: 1回のAPI呼び出しで複数拠点の出庫依頼をまとめて送信可能
- **リクエストボディ**: 拠点ごとの出庫依頼配列（拠点コード、配送予定日、明細リスト）
- **エラーハンドリング**: 
  - API呼び出し失敗時は画面にポップアップでエラー表示（リトライなし）
  - 一部拠点が失敗した場合、成功した拠点のみ「送信済」、失敗した拠点は「エラー」ステータス
- **LC自動倉庫側の処理**: APIリクエストを受信し、在庫引当・出庫処理を実施

### 3.4 出庫実績インタフェース（受信）
- **データの流れ**: LC自動倉庫 → 出庫指示システム（Webhook / Push型）
- **送信タイミング**: 出庫完了後即時（1日に複数回受信可能）
- **通信方式**: REST API（LC側から本システムのエンドポイントを呼び出し）、HTTPS
- **APIエンドポイント**: POST https://shipment-system.example.com/api/v1/shipment-results
- **認証方式**: JWTトークン（Authorizationヘッダー: Bearer {token}）
- **データ形式**: JSON
- **リクエストボディ**: 出庫実績配列（出庫実績ID、出庫依頼ID、パレットID、商品コード、数量、出庫区分、出庫日時、配送拠点、製造情報など）
- **手動出庫**: 出庫実績に含まれる（出庫依頼IDとの紐付けなし）
- **エラーハンドリング**: 
  - APIリクエスト受信エラー時はHTTPステータスコード500を返却
  - データ検証エラー時はHTTPステータスコード400を返却
  - 認証エラー時はHTTPステータスコード401を返却
  - エラー内容はログ出力のみ（画面表示なし）

### 3.5 エラーハンドリング
- **在庫情報取得・出庫依頼送信**: タイムアウト・APIエラー発生時は画面にポップアップでエラー表示（リトライなし）
- **出庫実績受信**: APIリクエスト受信エラー時はHTTPエラーレスポンスを返却し、ログ出力
- **配送拠点マスタ取り込み**: CSVファイル読み込みエラー時は画面にエラー表示

---

## 4. 業務運用フロー

### 4.1 出庫依頼の作成・送信フロー
1. **拠点倉庫担当の操作**（18:00までに実施を推奨。ただし締め切りなし）
   - 翌日配送分の出庫依頼を登録
   - 配送予定日はシステムが自動設定（登録日の翌営業日。土日のみ除外、祝日考慮不要）
   - 1画面で複数商品を入力可能
   - 一時保存機能あり
   - 登録 = 確定（承認フローなし）
   - ステータス：作成済
   - **在庫確認バリデーションなし**（在庫不足は後続フローで対応）

2. **LC倉庫担当の操作**（翌日実施）
   - 出庫依頼一覧画面で全拠点の依頼を確認
   - 在庫状況を確認（在庫照会画面で「最新化」ボタン押下、またはLC自動倉庫システムで直接確認）
   - 在庫不足時は拠点倉庫担当へ連絡し、数量調整（依頼の修正）
   - 送信対象の依頼をチェックボックスで選択（複数拠点選択可能）
   - 送信ボタン押下で、選択した全拠点の出庫依頼をLC自動倉庫へREST API送信
   - ステータス：送信済（=完了）/ エラー（送信失敗）
   - **一部拠点が失敗した場合、成功した拠点のみ「送信済」、失敗した拠点は「エラー」**

3. **LC自動倉庫の処理**
   - REST APIリクエストを受信
   - 在庫引当・出庫処理を実施
   - 出庫完了後、出庫実績を本システムのWebhookエンドポイントへ即時送信

4. **出庫実績の受信**
   - 出庫指示システムがLC自動倉庫からのWebhook（POST /api/v1/shipment-results）を受信
   - 出庫実績テーブルへ格納
   - **在庫データは保持しない**（在庫照会画面で都度LC APIから取得）

### 4.2 出庫依頼の修正・取消
- **送信前**：LC倉庫担当が出庫依頼一覧画面で修正・削除可能
- **送信後・出庫前**：LC倉庫担当がLC自動倉庫システムで直接キャンセルAPI呼び出し。再送信する場合は、出庫指示システムで訂正後、再送信

### 4.3 手動出庫
- 緊急出庫、廃棄などで発生
- 出庫依頼との紐付けなし
- 出庫実績CSVで受信し、出庫実績検索画面で参照可能

---

## 5. システム利用者と権限

### 5.1 ユーザー区分
1. **拠点倉庫担当**（30拠点）
   - 所属拠点のみ操作可能
   - 出庫依頼登録画面、在庫照会画面、出庫実績検索画面

2. **LC倉庫担当**
   - 全拠点のデータを操作可能
   - 商品マスタ管理画面、出庫依頼一覧・修正・送信画面、在庫照会画面、出庫実績検索画面

3. **管理者**（情報システム部門）
   - ユーザー管理画面のみ

### 5.2 ユーザー管理
- ユーザーマスタをシステム内で管理
- 管理者がユーザー管理画面で登録・更新
- ユーザーマスタに所属拠点コードを持たせて権限制御
- パスワード変更機能あり
- 初期パスワードはメールで通知

---

## 6. マスタデータ管理

### 6.1 商品マスタ
- **管理方式**：システム内で管理
- **登録・更新者**：LC倉庫担当
- **管理画面**：必要
- **必須項目**：
  - 商品コード
  - 商品名
  - パレット積載ケース数（出庫依頼数量のバリデーションに使用）

### 6.2 配送拠点マスタ
- **管理方式**：別システムからCSV受信（毎日7:00、全量入れ替え）
- **管理画面**：不要
- **データ項目**：拠点コード、拠点名

### 6.3 製造工場・ラインマスタ
- **管理方式**：不要（在庫情報・出庫実績の項目としてのみ保持）

---

## 7. 画面機能一覧

### 7.1 出庫依頼登録画面（拠点倉庫担当）
- 1画面で複数商品を入力可能
- 一時保存機能あり
- 複写機能不要
- 配送予定日は自動設定（登録日の翌営業日。土日除く）
- 依頼数量はパレット積載ケース数の倍数であること（バリデーション）

### 7.2 出庫依頼一覧・修正・送信画面（LC倉庫担当）
- 検索条件：配送予定日、配送拠点、ステータス、登録日など
- 一覧表示項目：出庫依頼ID、配送拠点、配送予定日、ステータス、合計数量、登録日時など
- 修正機能：依頼の数量調整が可能
- 送信機能：チェックボックスで複数拠点選択し、一括でREST API送信
- エラー表示：API送信失敗時は画面にポップアップでエラー表示

### 7.3 在庫照会画面（全ユーザー）
- **最新化ボタン**: 押下時にLC自動倉庫のREST APIを呼び出し、全在庫情報を取得して画面表示
- **初回表示**: 空のリストを表示（最新化ボタン押下を促す）
- **データ保存**: データベースには保存せず、画面表示のみ
- 表示項目：パレットID、商品コード、商品名、数量、ロケーション、製造工場、製造ライン、製造番号、製造年月日、賞味期限、入庫日時など
- 全ユーザーが参照可能（拠点制限なし）
- エラー表示：API呼び出し失敗時は画面にポップアップでエラー表示

### 7.4 出庫実績検索画面（全ユーザー）
- 利用者：LC倉庫担当（配送追跡、問合せ対応、実績確認）
- 検索条件：出庫日、配送拠点、商品コード、パレットID、製造日、賞味期限、出庫依頼IDなど
- 表示項目：商品コード、製造工場、ライン、製造番号、製造年月日、賞味期限など
- 手動出庫も含めて検索可能
- 全ユーザーが参照可能

### 7.5 商品マスタ管理画面（LC倉庫担当）
- 商品の登録・更新・削除（論理削除）
- 必須項目：商品コード、商品名、パレット積載ケース数

### 7.6 ユーザー管理画面（管理者）
- ユーザーの登録・更新・削除
- 項目：ユーザーID、パスワード、ユーザー名、ユーザー区分、所属拠点コード、有効フラグ

### 7.7 配送拠点マスタ取り込み画面（管理者またはLC倉庫担当）
- 共有フォルダのCSVファイルを手動で取り込み
- 取り込みボタン押下で、最新のCSVファイルを読み込み、全量入れ替え
- エラー表示：CSVファイル読み込み失敗時は画面にエラー表示

---

## 8. データ仕様

### 8.1 パレット単位の出庫
- 商品ごとにパレット積載ケース数が固定
- 出庫依頼数量は、パレット積載ケース数の倍数のみ許可
- パレット内の一部数量だけ出庫することはなし

### 8.2 在庫データの整合性
- **在庫情報はデータベースに保存しない**
- 在庫照会画面で「最新化」ボタン押下時に、LC自動倉庫のREST APIから最新在庫を取得して画面表示
- 出庫依頼登録時の在庫確認バリデーションは不要
- 在庫不足はLC倉庫担当が在庫照会画面またはLC自動倉庫システムで確認し、手動調整

### 8.3 配送予定日の自動計算
- 登録日（システム日付）の翌営業日を自動設定
- 土日のみ除外、祝日・特別休業日は考慮不要
- 例：金曜日登録 → 配送予定日は月曜日
- 18:00以降も登録可能（締め切りなし）

### 8.4 ステータス管理
- **出庫依頼ステータス**：
  - 作成済（拠点倉庫担当が登録）
  - 送信済（LC倉庫担当が送信完了。送信完了=完了）
  - エラー（送信失敗）
- **在庫ステータス・明細ステータス**：LC自動倉庫側で管理（本システムでは不要）

### 8.5 トレーサビリティ
- パレット単位で製造工場、ライン、製造番号、製造年月日、賞味期限を追跡可能
- 出庫実績と依頼の紐付けにより、依頼→実績の追跡が可能（自動出庫のみ）
- 手動出庫は依頼との紐付けなし

---

## 9. 非機能要件

### 9.1 技術要件
- **フレームワーク**: Djangoフレームワークを使用
- **REST APIクライアント**: requests ライブラリを使用
- **REST APIサーバー**: Django REST framework を使用
- **認証方式**: JWT（JSON Web Token）認証（djangorestframework-simplejwt使用）
- **通信プロトコル**: HTTPS（TLS 1.2以上）
- **JWT管理**: 
  - トークンの有効期限: アクセストークン30分、リフレッシュトークン24時間
  - シークレットキー: 環境変数で管理
  - アルゴリズム: HS256
- **証明書**: 本番環境は正式なSSL/TLS証明書を使用、開発環境は自己署名証明書可

### 9.2 データ保持
- 出庫実績データの削除・アーカイブは考慮不要
- **在庫データはデータベースに保持しない**（都度LC APIから取得）

---

---

## 10. REST APIインタフェース仕様

詳細なAPI仕様は別ドキュメント「API仕様.md」を参照してください。

### 10.1 APIエンドポイント一覧

#### LC自動倉庫側が提供するAPI
- **在庫情報取得API**: GET https://lc-warehouse-api.example.com/api/v1/inventory
- **出庫依頼送信API**: POST https://lc-warehouse-api.example.com/api/v1/shipment-requests

#### 本システムが提供するAPI
- **出庫実績受信API（Webhook）**: POST https://shipment-system.example.com/api/v1/shipment-results

### 10.2 認証方式
- JWT（JSON Web Token）認証
- Authorizationヘッダー: Bearer {JWTトークン}
- アクセストークン有効期限: 30分
- リフレッシュトークン有効期限: 24時間

### 10.3 通信プロトコル
- HTTPS（TLS 1.2以上）必須

---

## 11. 補足事項

### 10.1 LC自動倉庫との責任分界
- **本システムの責任範囲**：
  - 出庫依頼の登録・管理・REST API送信
  - 在庫情報のREST API取得・画面表示
  - 出庫実績のWebhook受信・格納
  - 各種検索・照会機能
  
- **LC自動倉庫の責任範囲**（検討対象外）：
  - 在庫引当ロジック
  - 在庫ステータス管理
  - 出庫作業の実施
  - パレットの物理的な管理
  - REST APIエンドポイントの提供

### 11.2 出庫依頼と実績の関係
- 自動出庫：出庫依頼と出庫実績が紐付く
- 手動出庫：出庫依頼との紐付けなし（緊急出庫、廃棄など）
- 出庫実績受信は依頼ステータスに影響しない（送信完了=完了）

### 11.3 REST API化に伴う変更点まとめ
1. **在庫情報**: CSV受信（毎日7:00）→ REST API取得（画面から手動）、DB保存なし
2. **出庫依頼**: CSV送信（拠点別ファイル）→ REST API送信（複数拠点一括）
3. **出庫実績**: CSV受信 → Webhook受信（POST /api/v1/shipment-results）
4. **配送拠点マスタ**: CSV受信（毎日7:00）→ CSV受信（手動取り込み）
5. **エラーハンドリング**: ログ出力のみ → 画面ポップアップ表示（在庫取得・出庫送信）
6. **インタフェースログ**: InterfaceReceiveLog/InterfaceSendLog テーブル削除
7. **認証方式**: APIキー認証 → JWT（JSON Web Token）認証
8. **通信プロトコル**: HTTP → HTTPS（TLS 1.2以上）
