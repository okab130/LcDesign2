# アーキテクチャ概要図

## 全体アーキテクチャ

```
┌────────────────────────────────────────────────────────────────────────┐
│ プレゼンテーション層                                                   │
│ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐          │
│ │出庫依頼    │ │在庫照会    │ │出庫実績    │ │マスタ管理  │          │
│ │画面        │ │画面        │ │検索画面    │ │画面        │          │
│ └────────────┘ └────────────┘ └────────────┘ └────────────┘          │
│ (Django Templates + HTML/CSS/JavaScript)                              │
└────────────────┬───────────────────────────────────────────────────────┘
                 │ HTTP/HTTPS
┌────────────────┴───────────────────────────────────────────────────────┐
│ アプリケーション層（Django）                                           │
│                                                                        │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ Views（画面コントローラー）                                    │   │
│ │ - 認証・認可                                                   │   │
│ │ - 入力検証                                                     │   │
│ │ - セッション管理                                               │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ REST API Layer (Django REST Framework)                         │   │
│ │ - Webhook受信エンドポイント                                    │   │
│ │ - JSON処理                                                     │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ ビジネスロジック層（Services）                                 │   │
│ │                                                                │   │
│ │ ┌──────────────────┐  ┌──────────────────┐                   │   │
│ │ │出庫依頼管理      │  │出庫実績管理      │                   │   │
│ │ │- 依頼登録・更新  │  │- 実績格納        │                   │   │
│ │ │- 配送予定日計算  │  │- 実績検索        │                   │   │
│ │ │- バリデーション  │  │- トレース情報    │                   │   │
│ │ │- 依頼送信        │  │                  │                   │   │
│ │ └──────────────────┘  └──────────────────┘                   │   │
│ │                                                                │   │
│ │ ┌──────────────────┐  ┌──────────────────┐                   │   │
│ │ │在庫照会サービス  │  │マスタ管理        │                   │   │
│ │ │- API呼び出し     │  │- 商品マスタ      │                   │   │
│ │ │- データ変換      │  │- 拠点マスタ      │                   │   │
│ │ │                  │  │- ユーザー管理    │                   │   │
│ │ └──────────────────┘  └──────────────────┘                   │   │
│ │                                                                │   │
│ │ ┌──────────────────────────────────────────────┐             │   │
│ │ │ LC倉庫APIクライアント                        │             │   │
│ │ │ - REST API通信（requests library）           │             │   │
│ │ │ - JSON変換                                   │             │   │
│ │ │ - エラーハンドリング                         │             │   │
│ │ │ - タイムアウト制御                           │             │   │
│ │ └──────────────────────────────────────────────┘             │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ データアクセス層（Django ORM）                                 │   │
│ │ - モデル定義                                                   │   │
│ │ - クエリ最適化                                                 │   │
│ │ - トランザクション管理                                         │   │
│ └────────────────────────────────────────────────────────────────┘   │
└────────────────┬───────────────────────────────────────────────────────┘
                 │
┌────────────────▼───────────────────────────────────────────────────────┐
│ データ層                                                               │
│                                                                        │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ データベース（SQLite3 / PostgreSQL）                           │   │
│ │                                                                │   │
│ │ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │   │
│ │ │出庫依頼    │ │出庫実績    │ │商品マスタ  │ │配送拠点    │ │   │
│ │ │テーブル    │ │テーブル    │ │            │ │マスタ      │ │   │
│ │ └────────────┘ └────────────┘ └────────────┘ └────────────┘ │   │
│ │                                                                │   │
│ │ ┌────────────┐                                                │   │
│ │ │ユーザー    │                                                │   │
│ │ │マスタ      │                                                │   │
│ │ └────────────┘                                                │   │
│ └────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘

         │                                    ▲
         │ REST API (Pull)                   │ Webhook (Push)
         │ - 在庫情報取得                     │ - 出庫実績受信
         │ - 出庫依頼送信                     │
         ▼                                    │
┌─────────────────────────────────────────────┴──────────────────────────┐
│ LC自動倉庫システム（外部システム）                                     │
│ - 在庫管理                                                             │
│ - 出庫処理                                                             │
│ - REST API提供                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

## レイヤー別責務

### 1. プレゼンテーション層
**責務**: ユーザーインターフェース提供

**構成要素**:
- Django Templates
- HTML/CSS
- JavaScript（軽微な動的処理）

**主要画面**:
- 出庫依頼登録画面
- 出庫依頼一覧・送信画面
- 在庫照会画面
- 出庫実績検索画面
- 商品マスタ管理画面
- ユーザー管理画面
- 配送拠点マスタ取り込み画面

### 2. アプリケーション層
**責務**: リクエスト処理、ビジネスロジック実行

#### 2.1 Views（画面コントローラー）
- ユーザー認証・認可
- セッション管理
- 入力値検証
- ビジネスロジック層の呼び出し
- レスポンス生成

#### 2.2 REST API Layer
- Webhookエンドポイント提供
- JSONリクエスト解析
- JSONレスポンス生成
- HTTPステータスコード制御

#### 2.3 ビジネスロジック層（Services）

**出庫依頼管理サービス**
- 出庫依頼の登録・更新・削除
- 配送予定日の自動計算（翌営業日）
- 数量バリデーション（パレット倍数チェック）
- 出庫依頼のREST API送信処理
- ステータス管理（作成済/送信済/エラー）

**出庫実績管理サービス**
- Webhook受信データの検証
- 出庫実績の格納
- 出庫実績の検索
- トレーサビリティ情報管理

**在庫照会サービス**
- LC倉庫APIの呼び出し
- 在庫データの変換・整形
- 画面表示用データ生成

**マスタ管理サービス**
- 商品マスタのCRUD操作
- 配送拠点マスタのCSV取り込み
- ユーザーマスタのCRUD操作

**LC倉庫APIクライアント**
- REST API通信（requestsライブラリ）
- JSON変換
- エラーハンドリング
- タイムアウト制御
- リトライ制御（必要に応じて）

### 3. データアクセス層
**責務**: データベース操作

**機能**:
- Django ORM によるデータアクセス
- クエリ最適化
- トランザクション管理
- データモデル定義

### 4. データ層
**責務**: データ永続化

**データベース**: SQLite3（開発）/ PostgreSQL（本番）

**主要テーブル**:
- 出庫依頼テーブル
- 出庫依頼明細テーブル
- 出庫実績テーブル
- 商品マスタ
- 配送拠点マスタ
- ユーザーマスタ

---

## 外部連携アーキテクチャ

### LC自動倉庫システムとの連携

```
┌─────────────────────────────────────────┐
│ LC出庫指示システム                      │
└───┬─────────────────────────────────┬───┘
    │                                 │
    │ ① 在庫情報取得（Pull型）        │ ③ 出庫実績受信（Push型）
    │   GET /api/v1/inventory         │   POST /api/v1/shipment-results
    │   タイミング: 画面から手動      │   タイミング: 出庫完了後即時
    │                                 │
    │ ② 出庫依頼送信                  │
    │   POST /api/v1/shipment-requests│
    │   タイミング: 画面から送信      │
    │                                 │
    ▼                                 ▲
┌─────────────────────────────────────────┐
│ LC自動倉庫システム                      │
│ - 在庫管理                              │
│ - 在庫引当                              │
│ - 出庫処理                              │
└─────────────────────────────────────────┘
```

### 連携パターン詳細

#### パターン1: 在庫情報取得（同期・Pull型）
```
ユーザー → [最新化ボタン押下] → 画面コントローラー
                                     ↓
                              在庫照会サービス
                                     ↓
                              LC倉庫APIクライアント
                                     ↓
                              GET /api/v1/inventory
                                     ↓
                              LC自動倉庫システム
                                     ↓
                              [JSON: 在庫データ]
                                     ↓
                              画面表示（DB保存なし）
```

#### パターン2: 出庫依頼送信（同期・Push型）
```
LC倉庫担当 → [送信ボタン押下] → 画面コントローラー
                                     ↓
                              出庫依頼管理サービス
                                     ↓
                              LC倉庫APIクライアント
                                     ↓
                              POST /api/v1/shipment-requests
                                     ↓
                              LC自動倉庫システム
                                     ↓
                              [JSON: 処理結果]
                                     ↓
                              ステータス更新（送信済/エラー）
```

#### パターン3: 出庫実績受信（非同期・Push型/Webhook）
```
LC自動倉庫システム → [出庫完了] → Webhook送信
                                     ↓
                              POST /api/v1/shipment-results
                                     ↓
                              REST APIエンドポイント
                                     ↓
                              データ検証
                                     ↓
                              出庫実績管理サービス
                                     ↓
                              実績テーブルに格納
                                     ↓
                              HTTP 200 OK 返却
```

---

## セキュリティアーキテクチャ

### 認証・認可フロー

```
┌─────────────┐
│ユーザー     │
└──────┬──────┘
       │
       ▼
┌──────────────────────┐
│ ログイン画面         │
└──────┬───────────────┘
       │ユーザーID/パスワード
       ▼
┌──────────────────────┐
│ 認証処理             │
│ - パスワード検証     │
│ - セッション生成     │
└──────┬───────────────┘
       │セッションID
       ▼
┌──────────────────────┐
│ 権限チェック         │
│ - ユーザー区分確認   │
│ - 所属拠点確認       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 画面・機能アクセス   │
└──────────────────────┘
```

### セキュリティ対策

**開発環境**:
- HTTP通信
- 認証なし（簡易実装）
- SQLite3

**本番環境（実装予定）**:
- HTTPS（TLS 1.2+）必須
- JWT認証（djangorestframework-simplejwt）
- パスワードハッシュ化（Django標準PBKDF2）
- CSRF保護（Django標準機能）
- XSS対策（Djangoテンプレート自動エスケープ）
- SQL Injection対策（Django ORM）
- PostgreSQL（データベース）

---

## エラーハンドリングアーキテクチャ

### エラー処理フロー

```
┌─────────────────────────────────────────┐
│ 画面操作                                │
└───┬─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 入力検証                                │
│ - 必須項目チェック                      │
│ - 形式チェック                          │
│ - 業務ルールチェック                    │
└───┬─────────────────────────────────────┘
    │エラー時
    ├───────► 画面にエラー表示
    │
    │正常時
    ▼
┌─────────────────────────────────────────┐
│ ビジネスロジック実行                    │
└───┬─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 外部API呼び出し                         │
│ - タイムアウト設定                      │
│ - 接続エラー検知                        │
└───┬─────────────────────────────────────┘
    │エラー時
    ├───────► ログ出力 → ポップアップ表示
    │         （在庫取得・出庫送信のみ）
    │
    │正常時
    ▼
┌─────────────────────────────────────────┐
│ データベース操作                        │
└───┬─────────────────────────────────────┘
    │エラー時
    ├───────► ロールバック → エラー画面
    │
    │正常時
    ▼
┌─────────────────────────────────────────┐
│ 処理完了                                │
└─────────────────────────────────────────┘
```

### Webhook受信時のエラー処理

```
LC自動倉庫 → POST /api/v1/shipment-results
                    ↓
              ┌─────────────────┐
              │ リクエスト受信  │
              └────┬────────────┘
                   │
                   ▼
              ┌─────────────────┐
              │ JSON解析        │
              └────┬────────────┘
                   │解析失敗
                   ├────────► HTTP 400 Bad Request
                   │           + ログ出力
                   │
                   │成功
                   ▼
              ┌─────────────────┐
              │ データ検証      │
              └────┬────────────┘
                   │検証エラー
                   ├────────► HTTP 400 Bad Request
                   │           + ログ出力
                   │
                   │成功
                   ▼
              ┌─────────────────┐
              │ DB保存          │
              └────┬────────────┘
                   │DB エラー
                   ├────────► HTTP 500 Internal Server Error
                   │           + ログ出力
                   │
                   │成功
                   ▼
              ┌─────────────────┐
              │ HTTP 200 OK     │
              └─────────────────┘
```

---

## パフォーマンス最適化

### データベースクエリ最適化
- SELECT文の最適化（必要なカラムのみ取得）
- インデックス活用
- N+1問題の回避（select_related / prefetch_related）
- ページネーション実装

### キャッシュ戦略
- 商品マスタのメモリキャッシュ
- 配送拠点マスタのメモリキャッシュ
- セッション情報のキャッシュ

### API通信最適化
- 接続プーリング（requests.Session）
- タイムアウト設定（読み取り: 30秒、接続: 10秒）
- 複数拠点一括送信による通信回数削減

---

## スケーラビリティ

### 水平スケーリング
- Webサーバーの複数台構成
- ロードバランサーによる負荷分散
- ステートレス設計

### 垂直スケーリング
- データベースサーバーのスペックアップ
- アプリケーションサーバーのリソース増強

### データベーススケーリング
- 読み取りレプリカの追加
- コネクションプーリング
- パーティショニング（将来的な大量データ対応）
