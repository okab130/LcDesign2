# C4モデル - LC出庫指示システム

## レベル1: システムコンテキスト図

```
                    ┌──────────────────┐
                    │  拠点倉庫担当    │
                    │   (30拠点)       │
                    └────────┬─────────┘
                             │
                 出庫依頼登録、在庫照会
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌──────────────────┐   ┌──────────────┐
│ LC倉庫担当    │   │ LC出庫指示       │   │  管理者      │
│               │──►│ システム         │◄──│ (情報システム)│
└───────────────┘   └────────┬─────────┘   └──────────────┘
 依頼確認・送信              │                ユーザー管理
 在庫照会・実績検索          │
                             │
                             │REST API / Webhook
                             │
                    ┌────────┴─────────┐
                    │ LC自動倉庫       │
                    │ システム         │
                    └──────────────────┘
                    在庫管理・出庫処理
```

### 外部システム/ユーザー

**ユーザー（アクター）**

1. **拠点倉庫担当（30拠点）**
   - 所属拠点の出庫依頼を登録
   - 在庫照会、出庫実績検索を実施
   - 権限: 自拠点のみ

2. **LC倉庫担当**
   - 全拠点の出庫依頼を確認・調整・送信
   - 商品マスタ管理、在庫照会、実績検索
   - 権限: 全拠点

3. **管理者（情報システム部門）**
   - ユーザー管理
   - 配送拠点マスタ取り込み
   - 権限: システム管理のみ

**外部システム**

4. **LC自動倉庫システム**
   - 在庫管理・出庫処理を実施
   - REST APIで在庫情報を提供
   - 出庫依頼をREST APIで受信
   - 出庫実績をWebhookで送信

5. **別システム（配送拠点マスタ管理）**
   - 配送拠点マスタをCSVファイルで提供

---

## レベル2: コンテナ図

```
┌────────────────────────────────────────────────────────────────┐
│ LC出庫指示システム                                             │
│                                                                │
│  ┌──────────────────┐         ┌────────────────────┐          │
│  │ Webアプリケーション│        │ REST APIサーバー   │          │
│  │ (Django Views)   │────────│ (Django REST       │          │
│  │                  │        │  Framework)        │          │
│  │ - 画面表示       │        │                    │          │
│  │ - 入力検証       │        │ - 出庫実績受信     │          │
│  │ - セッション管理 │        │   (Webhook)        │          │
│  └────────┬─────────┘        └──────────┬─────────┘          │
│           │                             │                    │
│           └─────────────┬───────────────┘                    │
│                         │                                    │
│              ┌──────────▼──────────┐                         │
│              │ ビジネスロジック層  │                         │
│              │ (Django Models/     │                         │
│              │  Services)          │                         │
│              │                     │                         │
│              │ - 出庫依頼管理      │                         │
│              │ - 出庫実績管理      │                         │
│              │ - マスタ管理        │                         │
│              │ - API通信処理       │                         │
│              └──────────┬──────────┘                         │
│                         │                                    │
│              ┌──────────▼──────────┐                         │
│              │ データアクセス層    │                         │
│              │ (Django ORM)        │                         │
│              └──────────┬──────────┘                         │
│                         │                                    │
│              ┌──────────▼──────────┐                         │
│              │ データベース        │                         │
│              │ (SQLite3 / PostgreSQL)│                       │
│              │                     │                         │
│              │ - 出庫依頼          │                         │
│              │ - 出庫実績          │                         │
│              │ - マスタデータ      │                         │
│              └─────────────────────┘                         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
         │                                      ▲
         │ REST API                             │ Webhook
         │ (在庫取得・出庫依頼送信)             │ (出庫実績)
         ▼                                      │
┌─────────────────────────────────────────────────┐
│ LC自動倉庫システム                              │
│ - 在庫管理API                                   │
│ - 出庫処理API                                   │
└─────────────────────────────────────────────────┘
```

### コンテナ詳細

1. **Webアプリケーション（Django Views）**
   - 技術: Python Django 4.x
   - 責任: 画面表示、入力検証、認証・認可
   - 通信: HTTPSでブラウザと通信

2. **REST APIサーバー（Django REST Framework）**
   - 技術: Django REST Framework 3.x
   - 責任: Webhook受信、JSON処理
   - 通信: HTTPでLC自動倉庫からWebhook受信

3. **ビジネスロジック層**
   - 技術: Python、Django Models/Services
   - 責任: 業務ロジック実装、外部API通信
   - ライブラリ: requests（REST APIクライアント）

4. **データアクセス層**
   - 技術: Django ORM
   - 責任: データベース操作

5. **データベース**
   - 技術: SQLite3（開発）/ PostgreSQL 14+（本番）
   - 責任: データ永続化

---

## レベル3: コンポーネント図

### Webアプリケーションコンポーネント

```
┌─────────────────────────────────────────────────────┐
│ Webアプリケーション                                 │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ 認証・認可コンポーネント             │          │
│  │ - ログイン処理                       │          │
│  │ - セッション管理                     │          │
│  │ - 権限チェック（拠点制限）           │          │
│  └───────────────┬──────────────────────┘          │
│                  │                                  │
│  ┌───────────────▼──────────────────────┐          │
│  │ 画面コントローラー                   │          │
│  │                                      │          │
│  │ ┌──────────────────────────────┐    │          │
│  │ │ 出庫依頼コントローラー       │    │          │
│  │ │ - 登録画面                   │    │          │
│  │ │ - 一覧・送信画面             │    │          │
│  │ └──────────────────────────────┘    │          │
│  │                                      │          │
│  │ ┌──────────────────────────────┐    │          │
│  │ │ 在庫照会コントローラー       │    │          │
│  │ │ - 在庫照会画面               │    │          │
│  │ └──────────────────────────────┘    │          │
│  │                                      │          │
│  │ ┌──────────────────────────────┐    │          │
│  │ │ 出庫実績コントローラー       │    │          │
│  │ │ - 実績検索画面               │    │          │
│  │ └──────────────────────────────┘    │          │
│  │                                      │          │
│  │ ┌──────────────────────────────┐    │          │
│  │ │ マスタ管理コントローラー     │    │          │
│  │ │ - 商品マスタ画面             │    │          │
│  │ │ - ユーザー管理画面           │    │          │
│  │ │ - 拠点マスタ取り込み画面     │    │          │
│  │ └──────────────────────────────┘    │          │
│  └──────────────────────────────────────┘          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### ビジネスロジックコンポーネント

```
┌─────────────────────────────────────────────────────┐
│ ビジネスロジック層                                  │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ 出庫依頼管理サービス                 │          │
│  │ - 出庫依頼登録・更新・削除           │          │
│  │ - 配送予定日自動計算                 │          │
│  │ - 数量バリデーション                 │          │
│  │ - 出庫依頼送信処理                   │          │
│  └──────────────────────────────────────┘          │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ 出庫実績管理サービス                 │          │
│  │ - 出庫実績格納                       │          │
│  │ - 出庫実績検索                       │          │
│  └──────────────────────────────────────┘          │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ 在庫照会サービス                     │          │
│  │ - 在庫API呼び出し                    │          │
│  │ - 在庫データ変換・表示               │          │
│  └──────────────────────────────────────┘          │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ LC倉庫APIクライアント                │          │
│  │ - REST API通信                       │          │
│  │ - JSON変換                           │          │
│  │ - エラーハンドリング                 │          │
│  │ - タイムアウト処理                   │          │
│  └──────────────────────────────────────┘          │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ マスタ管理サービス                   │          │
│  │ - 商品マスタCRUD                     │          │
│  │ - 拠点マスタCSV取り込み              │          │
│  │ - ユーザーマスタCRUD                 │          │
│  └──────────────────────────────────────┘          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### REST APIサーバーコンポーネント

```
┌─────────────────────────────────────────────────────┐
│ REST APIサーバー                                    │
│                                                     │
│  ┌──────────────────────────────────────┐          │
│  │ Webhookエンドポイント                │          │
│  │ POST /api/v1/shipment-results        │          │
│  │                                      │          │
│  │ - HTTPリクエスト受信                 │          │
│  │ - JSON解析                           │          │
│  │ - データ検証                         │          │
│  │ - ビジネスロジック呼び出し           │          │
│  │ - HTTPレスポンス返却                 │          │
│  └──────────────────────────────────────┘          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## レベル4: コード図（主要クラス）

### Djangoモデル（データモデル）

```python
# models.py

class ShipmentRequest(models.Model):
    """出庫依頼"""
    shipment_request_id = models.AutoField(primary_key=True)
    delivery_base_code = models.CharField(max_length=10)
    scheduled_delivery_date = models.DateField()
    status = models.CharField(max_length=20)  # 作成済/送信済/エラー
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    created_user_id = models.CharField(max_length=50)

class ShipmentRequestDetail(models.Model):
    """出庫依頼明細"""
    detail_id = models.AutoField(primary_key=True)
    shipment_request = models.ForeignKey(ShipmentRequest)
    product_code = models.CharField(max_length=20)
    quantity = models.IntegerField()

class ShipmentResult(models.Model):
    """出庫実績"""
    shipment_result_id = models.CharField(max_length=50, primary_key=True)
    shipment_request_id = models.CharField(max_length=50, null=True)
    pallet_id = models.CharField(max_length=50)
    product_code = models.CharField(max_length=20)
    quantity = models.IntegerField()
    shipment_type = models.CharField(max_length=10)  # 自動/手動
    shipment_datetime = models.DateTimeField()
    delivery_base_code = models.CharField(max_length=10)
    manufacturing_plant_code = models.CharField(max_length=10)
    manufacturing_line_code = models.CharField(max_length=10)
    manufacturing_number = models.CharField(max_length=50)
    manufacturing_date = models.DateField()
    expiry_date = models.DateField()

class Product(models.Model):
    """商品マスタ"""
    product_code = models.CharField(max_length=20, primary_key=True)
    product_name = models.CharField(max_length=100)
    pallet_capacity = models.IntegerField()
    is_active = models.BooleanField(default=True)

class DeliveryBase(models.Model):
    """配送拠点マスタ"""
    base_code = models.CharField(max_length=10, primary_key=True)
    base_name = models.CharField(max_length=100)

class User(models.Model):
    """ユーザーマスタ"""
    user_id = models.CharField(max_length=50, primary_key=True)
    user_name = models.CharField(max_length=100)
    password = models.CharField(max_length=255)  # ハッシュ化
    user_type = models.CharField(max_length=20)
    base_code = models.CharField(max_length=10, null=True)
    is_active = models.BooleanField(default=True)
```

### サービスクラス

```python
# services/shipment_request_service.py

class ShipmentRequestService:
    """出庫依頼サービス"""
    
    def create_request(self, base_code, details, user_id):
        """出庫依頼登録"""
        pass
    
    def calculate_delivery_date(self, request_date):
        """配送予定日自動計算"""
        pass
    
    def validate_quantity(self, product_code, quantity):
        """数量バリデーション"""
        pass
    
    def send_requests(self, request_ids):
        """出庫依頼送信"""
        pass

# services/lc_warehouse_api_client.py

class LCWarehouseAPIClient:
    """LC倉庫APIクライアント"""
    
    def get_inventory(self):
        """在庫情報取得"""
        pass
    
    def send_shipment_request(self, request_data):
        """出庫依頼送信"""
        pass

# services/shipment_result_service.py

class ShipmentResultService:
    """出庫実績サービス"""
    
    def save_results(self, results_data):
        """出庫実績格納"""
        pass
    
    def search_results(self, search_criteria):
        """出庫実績検索"""
        pass
```

---

## 技術スタック

### フロントエンド
- Django Templates
- HTML5 / CSS3
- JavaScript（軽微な動的処理）

### バックエンド
- **言語**: Python 3.10+
- **フレームワーク**: Django 4.x
- **REST API**: Django REST Framework 3.x
- **HTTP Client**: requests

### データベース
- **開発環境**: SQLite3
- **本番環境**: PostgreSQL 14+

### インフラ（本番想定）
- **Webサーバー**: Nginx / Apache
- **アプリケーションサーバー**: Gunicorn / uWSGI
- **OS**: Linux（Ubuntu / CentOS）

### セキュリティ
- **認証**: Django認証フレームワーク（本番: JWT追加）
- **通信**: HTTP（開発）/ HTTPS TLS 1.2+（本番）
- **パスワード**: Django標準ハッシュ化（PBKDF2）

---

## デプロイメント構成（本番環境想定）

```
┌─────────────────────────────────────────────────┐
│ インターネット                                  │
└────────────────┬────────────────────────────────┘
                 │ HTTPS
        ┌────────▼────────┐
        │ ロードバランサー │
        └────────┬────────┘
                 │
        ┌────────┴────────┐
        │                 │
┌───────▼───────┐  ┌──────▼────────┐
│ Webサーバー1  │  │ Webサーバー2  │
│ (Nginx)       │  │ (Nginx)       │
└───────┬───────┘  └──────┬────────┘
        │                 │
┌───────▼───────┐  ┌──────▼────────┐
│ Appサーバー1  │  │ Appサーバー2  │
│ (Gunicorn)    │  │ (Gunicorn)    │
│ Django        │  │ Django        │
└───────┬───────┘  └──────┬────────┘
        │                 │
        └────────┬────────┘
                 │
        ┌────────▼────────┐
        │ データベース    │
        │ (PostgreSQL)    │
        │ - Primary       │
        │ - Replica(読取) │
        └─────────────────┘
```
