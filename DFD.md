# データフロー図（DFD）

## レベル0 - コンテキスト図

```
┌─────────────────┐
│  拠点倉庫担当   │
│   (30拠点)      │
└────────┬────────┘
         │出庫依頼登録
         │在庫照会
         │実績照会
         ▼
┌─────────────────────────┐      ┌──────────────┐
│                         │◄─────┤ LC自動倉庫   │
│  LC出庫指示システム     │      │ システム     │
│                         ├─────►└──────────────┘
└─────────────────────────┘      在庫情報取得
         ▲                        出庫依頼送信
         │依頼確認・送信          出庫実績受信
         │在庫照会
         │実績照会
┌────────┴────────┐
│  LC倉庫担当     │
└─────────────────┘
         ▲
         │ユーザー管理
┌────────┴────────┐
│    管理者       │
└─────────────────┘
```

## レベル1 - 主要プロセス

```
┌─────────────────┐
│ 拠点倉庫担当    │
└────┬────────────┘
     │
     ▼
┌────────────────────────┐
│ 1.0 出庫依頼管理       │
│  - 出庫依頼登録        │
│  - 一時保存            │
└──────┬─────────────────┘
       │出庫依頼データ
       ▼
┌────────────────────────┐      ┌──────────────────┐
│ D1: 出庫依頼テーブル   │◄─────┤ 2.0 出庫依頼送信 │
└──────┬─────────────────┘      │  - 依頼確認      │
       │                        │  - 数量調整      │
       │                        │  - API送信       │
       │                        └────┬─────────────┘
       │                             │REST API
       │                             ▼
       │                        ┌──────────────────┐
       │                        │ LC自動倉庫       │
       │                        │ システム         │
       │                        └────┬─────────────┘
       │                             │Webhook
       │                             ▼
       │                        ┌──────────────────┐
       │                        │ 3.0 出庫実績受信 │
       │                        │  - データ検証    │
       │                        │  - 実績格納      │
       │                        └────┬─────────────┘
       │                             │出庫実績データ
       ▼                             ▼
┌────────────────────────┐      ┌──────────────────┐
│ 4.0 在庫照会           │      │ D2: 出庫実績     │
│  - API呼び出し         │◄──┐  │   テーブル       │
│  - 画面表示            │   │  └──────────────────┘
└────────────────────────┘   │
       ▲                     │
       │REST API              │
       │                     │
┌──────┴──────────────┐      │
│ LC自動倉庫          │      │
│ システム            │      │
└─────────────────────┘      │
                              │
┌────────────────────────┐   │
│ 5.0 出庫実績検索       │───┘
│  - 条件検索            │
│  - 一覧表示            │
└────────────────────────┘
       ▲
       │
┌──────┴──────────┐
│ LC倉庫担当      │
│ 拠点倉庫担当    │
└─────────────────┘
```

## レベル2 - 詳細プロセス

### 1.0 出庫依頼管理の詳細

```
┌─────────────────┐
│ 拠点倉庫担当    │
└────┬────────────┘
     │
     ▼
┌────────────────────────┐
│ 1.1 配送予定日算出     │
│  - システム日付取得    │
│  - 翌営業日計算        │
│  (土日除外)            │
└──────┬─────────────────┘
       │配送予定日
       ▼
┌────────────────────────┐      ┌──────────────────┐
│ 1.2 商品・数量入力     │◄─────┤ D3: 商品マスタ   │
│  - 商品選択            │      └──────────────────┘
│  - 数量入力            │
│  - バリデーション      │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│ 1.3 依頼データ保存     │
│  - ステータス: 作成済  │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│ D1: 出庫依頼テーブル   │
└────────────────────────┘
```

### 2.0 出庫依頼送信の詳細

```
┌─────────────────┐
│ LC倉庫担当      │
└────┬────────────┘
     │
     ▼
┌────────────────────────┐      ┌──────────────────┐
│ 2.1 依頼一覧表示       │◄─────┤ D1: 出庫依頼     │
│  - 検索・絞り込み      │      │   テーブル       │
└──────┬─────────────────┘      └──────────────────┘
       │
       ▼
┌────────────────────────┐
│ 2.2 在庫確認           │
│  - API呼び出し         │
│  - 在庫数量確認        │
└──────┬─────────────────┘
       │不足時
       ▼
┌────────────────────────┐      ┌──────────────────┐
│ 2.3 数量調整           │─────►│ D1: 出庫依頼     │
│  - 依頼修正            │      │   更新           │
└────────────────────────┘      └──────────────────┘
       │
       ▼
┌────────────────────────┐      ┌──────────────────┐
│ 2.4 複数拠点選択       │◄─────┤ D1: 出庫依頼     │
│  - チェックボックス    │      └──────────────────┘
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│ 2.5 REST API送信       │
│  - JSON変換            │
│  - POST実行            │
│  - エラーハンドリング  │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐      ┌──────────────────┐
│ 2.6 ステータス更新     │─────►│ D1: 出庫依頼     │
│  - 送信済 / エラー     │      │   更新           │
└────────────────────────┘      └──────────────────┘
       │
       ▼
┌─────────────────┐
│ LC自動倉庫      │
│ システム        │
└─────────────────┘
```

### 3.0 出庫実績受信の詳細

```
┌─────────────────┐
│ LC自動倉庫      │
│ システム        │
└────┬────────────┘
     │Webhook (POST)
     ▼
┌────────────────────────┐
│ 3.1 リクエスト受信     │
│  - HTTPリクエスト受信  │
│  - JSON解析            │
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│ 3.2 データ検証         │
│  - 必須項目チェック    │
│  - データ型チェック    │
└──────┬─────────────────┘
       │エラー時
       ├─────────────────┐
       │                 ▼
       │            HTTP 400/500
       │
       │正常時
       ▼
┌────────────────────────┐      ┌──────────────────┐
│ 3.3 実績データ格納     │─────►│ D2: 出庫実績     │
│  - パレット単位        │      │   テーブル       │
│  - トレース情報保存    │      └──────────────────┘
└──────┬─────────────────┘
       │
       ▼
┌────────────────────────┐
│ 3.4 HTTPレスポンス返却 │
│  - 200 OK              │
└────────────────────────┘
```

## データストア詳細

### D1: 出庫依頼テーブル
- 出庫依頼ID（PK）
- 配送拠点コード
- 配送予定日
- ステータス（作成済/送信済/エラー）
- 登録日時
- 更新日時
- 登録ユーザーID

### D2: 出庫実績テーブル
- 出庫実績ID（PK）
- 出庫依頼ID（FK、NULL可）
- パレットID
- 商品コード
- 数量
- 出庫区分（自動/手動）
- 出庫日時
- 配送拠点コード
- 製造工場コード
- 製造ラインコード
- 製造番号
- 製造年月日
- 賞味期限

### D3: 商品マスタ
- 商品コード（PK）
- 商品名
- パレット積載ケース数
- 有効フラグ

### D4: 配送拠点マスタ
- 拠点コード（PK）
- 拠点名

### D5: ユーザーマスタ
- ユーザーID（PK）
- ユーザー名
- パスワード（ハッシュ化）
- ユーザー区分
- 所属拠点コード
- 有効フラグ

## 外部システムとのデータフロー

### LC自動倉庫システム

**在庫情報取得（Pull型）**
```
出庫指示システム → [GET /api/v1/inventory] → LC自動倉庫
                ← [JSON: 全在庫データ]      ←
```

**出庫依頼送信**
```
出庫指示システム → [POST /api/v1/shipment-requests] → LC自動倉庫
                ← [JSON: 処理結果]                   ←
```

**出庫実績受信（Push型/Webhook）**
```
LC自動倉庫 → [POST /api/v1/shipment-results] → 出庫指示システム
           ← [HTTP 200 OK]                    ←
```

### 配送拠点マスタ連携

**CSVファイル取り込み（手動）**
```
共有フォルダ → [delivery_base_YYYYMMDD.csv] → 出庫指示システム
             ← [取り込み完了]                ←
```

## データフローの特徴

1. **在庫情報の非保持**
   - 在庫データはDB保存せず、都度API取得
   - リアルタイム性確保

2. **非同期実績受信**
   - Webhook方式で出庫完了後即時受信
   - 依頼ステータスとは独立管理

3. **複数拠点一括送信**
   - 1回のAPI呼び出しで複数拠点の依頼を送信
   - 部分的な失敗にも対応

4. **手動出庫の扱い**
   - 依頼との紐付けなし
   - 実績としてのみ記録
